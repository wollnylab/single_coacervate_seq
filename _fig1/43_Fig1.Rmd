---
title: "Figure 1 - Draft"
author: "Damian Wollny"
output:
  html_document:
    theme: paper
    df_print: kable
date: '`r format(Sys.Date(), "%B %d, %Y")`'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = FALSE, message = FALSE)
#options(width = 12)
```

```{r}
# Setup
library(tidyverse)
library(factoextra)
library(cowplot)

theme_set(theme_classic(base_size=24))
setwd(dir = "~/PD/Data/OoL/43_Draft_5/_fig1/_coacervates/")
```

<style type="text/css">

body, td {
   font-size: 18px;
}
</style>

### Input:

Cleaned up integrated data all experiments:

`/Users/damian_wollny/PD/Data/OoL/19.1_Draft_2/Generate_input/draft2_input.RDS`

```{r}
# Load seq data
master <- readRDS(file = "/Users/damian_wollny/PD/Data/OoL/19.1_Draft_2/Generate_input/draft2_input.RDS")
```

### Figure 1A

Schematic representation of the workflow

```{r}
a_scheme <- ggdraw() + draw_image("/Users/damian_wollny/PD/Schemes/OoL/fig1.5.png")
plot(a_scheme)
```

### Figure 1B

Correlation: FSC vs. SSC

```{r}
# load FACS data
facs_data <- readRDS(file = "/Users/damian_wollny/PD/Data/OoL/18.2_integrative_analysis/_8_coacervate_size_comp/master_facs.RDS")

# Format data: PDDA(no RNA)
fig1b_data_no_rna <- facs_data %>% filter(experiment == "ool17_noRNA" | experiment == "ool18_noRNA") %>% 
  mutate(log2_FSC = log2(`FSC-A`)) %>% 
  mutate(log2_SSC = log2(`SSC-A`))
fig1b_m_no_rna <- lm(`SSC-A` ~ `FSC-A`, fig1b_data_no_rna) 
fig1b_r2_no_rna <- as.character(paste("R^2 =", round(summary(fig1b_m_no_rna)$r.squared, 3), sep = " "))
fig1b_pears_no_rna <- paste("r = ", round(cor(fig1b_data_no_rna$`FSC-A`, fig1b_data_no_rna$`SSC-A`), 2), sep = "")

# Plot:
fig1b_plot <- ggplot(data = fig1b_data_no_rna, aes(x = `log2_FSC`, y = `log2_SSC`)) +
  geom_point(size = 3, alpha = .7, shape = 21) +
  annotate(geom = 'text', label = fig1b_pears_no_rna, x = min(fig1b_data_no_rna$log2_FSC), y = max(fig1b_data_no_rna$log2_SSC), hjust = 0, vjust = 1, size = 6) +
  stat_smooth(col = "indianred3", alpha = .3)  +
  labs(y = "Condensate granularity\nlog2(SSC)", x = "Condensate size\nlog2(FSC)") 
plot(fig1b_plot)

ggsave(fig1b_plot, file="./fig1b.pdf",width = 6, height = 6, device = "pdf")
```

### Figure 1C

Correlation: Condensate size vs. number of transcripts detected for PDDA condensates

```{r}
# Prepare dataframe:
fig1c_data <- master %>% 
  filter(experiment == "ool17" | experiment == "ool18") %>% 
  drop_na() %>% 
  filter(tpm != 0) %>% 
  group_by(experiment, cell_id) %>%
  summarise(n = n(), FSC = FSC[1], SSC = SSC[1], p_pseudoaligned[1], experiment[1], log2_FSC = log2(FSC[1])) %>% 
  filter(n < 7000)

# Calc correlation
fig1c_m <- lm(n ~ log2_FSC, fig1c_data) 
fig1c_r2 <- as.character(paste("R^2 =", round(summary(fig1c_m)$r.squared, 3), sep = " "))
fig1c_pears <- paste("r = ", round(cor(fig1c_data$log2_FSC, fig1c_data$n), 2), sep = "")


# Plot:
fig1c_plot <- ggplot(data = fig1c_data, aes(x = log2_FSC, y = n)) +
  geom_point(size = 4, alpha = .7, shape = 21) +
  stat_smooth(method = "lm", col = "indianred2")  +
  #scale_x_continuous(trans = "log10") +
  annotate(geom = 'text', label = fig1c_pears, x = min(fig1c_data$log2_FSC), y = max(fig1c_data$n), hjust = -.1, vjust = 1, size = 6) +
  #xlim(c(0,3e5)) +
  labs(x = "Condensate size\nlog2(FSC)", y = "Number of\ndetected transcripts") 
plot(fig1c_plot)

ggsave(fig1c_plot, file="./new_plot.pdf",width = 6, height = 6, device = "pdf")
```

### Figure 1D

Get GC content of each transcript for PCA

```{r}
# 1.) Export transcript ids 
pdda_target_ids <- master %>% 
  mutate(new_cell_id = paste(cell_id, experiment, sep = "_")) %>% 
  filter(experiment == "ool18" | experiment == "ool17" ) %>% 
  filter(tpm != 0) %>% 
  dplyr::select(target_id) %>% 
  distinct()
# Number of distinct transcripts:
pdda_target_ids %>% nrow()
# Export as input for base_content.py
# write.table(pdda_target_ids, file = "./pdda_target_ids.txt")

# 2.) Get sequences of each transcript and calculate gc content using custom python script:
#     base_content.py

# 3.) Import GC content information
pdda_base_content <- read.csv(file = "./pdda_resids_filter_seqs_bases.csv")
pdda_incl_bc <- master %>% 
  left_join(., pdda_base_content, by = "target_id")
```

Lower dimensionality PCA: compute PCA using droplet features instead of genes as variables

```{r}
# format dataframe for PCA
pdda <- pdda_incl_bc %>% 
  mutate(new_cell_id = paste(cell_id, experiment, sep = "_")) %>% 
  filter(experiment == "ool17" | experiment == "ool18") %>% 
  filter(tpm != 0) %>% 
  group_by(new_cell_id) %>% 
  summarise(mean_length = mean(length), 
            mean_gc = mean(rel_GC),
            FSC = FSC[1], SSC = SSC[1], 
            num_trans = n()) %>% 
  filter(FSC != is.na(FSC))

# Convert df into matrix; format and scale
pdda2 <- as.matrix(pdda)
row.names(pdda2) <- pdda2[,1]
pdda2 <- pdda2[,c(2:length(colnames(pdda2)))]
class(pdda2)<-"numeric"
scale_pdda2 <- scale(pdda2)

# run pca: input for prcomp needs to be a cell (rows) x gene (cols) matrix
res.pca <- prcomp(scale_pdda2)

# format pca object for plotting
df_out <- as.data.frame(res.pca$x)
var <- get_pca_var(res.pca)
var_df <- as.data.frame(var$coord) %>% dplyr::rename(PC1 = Dim.1, PC2 = Dim.2, PC3 = Dim.3, PC4 = Dim.4, PC5 = Dim.5)
var_df.1 <- as.data.frame(var$coord) %>% dplyr::rename(PC1 = Dim.1, PC2 = Dim.2, PC3 = Dim.3, PC4 = Dim.4, PC5 = Dim.5)
rownames(var_df.1) <- c("Ave transcript length","GC content","FSC", "SSC", "Num of\ntranscripts") 

# df for PC labels
var_df.2 <- var_df.1[,c(1:2)]
var_df.2[,1] <- c(-0.5,-1,-5,-5,-4.5)
var_df.2[,2] <- c(-3.5,3.5,-1.2,-2,.7)

# plot PCA including variable arrows
fig1d_plot <- ggplot(data= df_out, aes(x = PC1, y = PC2)) +
  geom_point(size = 4, alpha = .7, shape = 21) +
  geom_segment(x = 0, xend = 0, y = -7.5, yend = 8, linetype=3) +
  geom_segment(x = -12.5, xend = 5, y = 0, yend = 0, linetype=3) +
  # scale arrows x3 for visiblity
  geom_segment(data= var_df*5, aes(x= 0, y=0, xend = PC1*1, yend= PC2*1), size = 1.5, alpha = 1, color = "indianred2", arrow = arrow(length = unit(0.1, "inches"))) +
  geom_label(data = var_df.2*1.5, aes(label = rownames(var_df.1), fontface=1), color = "black", size = 6, alpha = .5) +
  scale_x_continuous(limits=c(-12,+5), expand = c(0, 0)) +
  scale_y_continuous(limits=c(-7.5,8), expand = c(0, 0)) +
  labs(x = "PC1 (68.9%)", y = "PC2 (20.6%)", title = "")
plot(fig1d_plot)

ggsave(fig1d_plot, file="./fig1d.pdf",width = 6, height = 6, device = "pdf")
```

### Figure 1E

```{r}
fig1e_plot <- ggplot(data = pdda, aes(x = mean_length, y = num_trans, fill = (FSC))) +
  geom_point(size = 4, alpha = .8, shape = 21) +
  scale_fill_distiller(palette = "Spectral", name = "Condensate\nsize") +
  theme(legend.position = c(.8,.8),   legend.key.size = unit(.6, "cm"), legend.key.width = unit(.5,"cm"), 
        legend.title = element_text(size = 22), legend.text = element_text(size = 20)) +
  labs(y = "Number of transcripts", x = "Ave transcript length [bp]")
plot(fig1e_plot)

ggsave(fig1e_plot, file="./fig1e.pdf", width = 6, height = 6, device = "pdf")
```

```{r, eval=F}
# another suggestion for the plot in Fig 1E:
fig1e_new_plot <- ggplot(data = pdda, aes(y = num_trans, x = mean_length,  size = (FSC))) +
  geom_point(alpha = .8, shape = 21) +
  scale_fill_distiller(palette = "Spectral", name = "Ave RNA\nlength") +
  stat_smooth(col = "indianred2", show.legend = FALSE) +
  theme(legend.position = c(.8,.8),   legend.key.size = unit(.6, "cm"), legend.key.width = unit(.5,"cm"), 
        legend.title = element_text(size = 22), legend.text = element_text(size = 20)) +
  labs(y = "Number of transcripts", x = "Ave transcript length [bp]")
plot(fig1e_new_plot)
ggsave(fig1e_new_plot, file="./fig1e_new.pdf", width = 6, height = 6, device = "pdf")
```