---
title: "ool41: Adressing Rev2"
author: "Damian Wollny"
date: "03/16/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,fig.width= 12, fig.height=7)
```

```{r}
library(tidyverse)
library(data.table)
library(mgcv)
library(seqinr)

theme_set(theme_classic(base_size=22))
```

Original analysis can be found at:
/Users/damian_wollny/PD/Data/OoL/41_mef_rna_droplets/_3_popul_rnas

```{r}
master <- readRDS(file = "/Users/damian_wollny/PD/Data/OoL/19.1_Draft_2/Generate_input/draft2_input.RDS") %>% as.tbl()
ool41 <- readRDS(file = "/Users/damian_wollny/PD/Data/OoL/41_mef_rna_droplets/_1_data_prep/master.RDS") %>% as.tbl()
ool41_droplets <- ool41 %>% 
  as.tbl() %>% 
  filter(grepl(pattern = "ool41*", .$cell_id)) %>% 
  # kickout + ctrl (1000 droplets) & - ctrl (0 droplets)
  filter(cell_id != "ool41_p1_a1",
         cell_id != "ool41_p2_a1",
         cell_id != "ool41_p1_h12",
         cell_id != "ool41_p2_h12")
```

________________________________________

#### Ben's plot 5ng

```{r}
input_tpm <- ool41 %>%
  filter(cell_id == "mef_5ng") %>% 
  filter(tpm != 0) %>% 
  group_by(target_id) %>% 
  summarise(input_tpm = log2_tpm)

mef_bens_plot <- ool41_droplets %>% 
  filter(tpm != 0) %>% 
  group_by(target_id) %>% 
  summarise(ave_tpm = mean(log2_tpm), count = n()) %>% 
  inner_join(.,input_tpm, by="target_id") %>% distinct() %>% 
  arrange(desc(count)) %>% 
  mutate(percent = count*100/max(count)) 

# get residuals from model describing data in bens_plot
mef_bens_plot_model <- gam(percent ~ s(input_tpm, bs = "cs"), data = mef_bens_plot)
mef_bens_plot_5ng <- mef_bens_plot %>% mutate(residuals = mef_bens_plot_model$residuals)

bens_plot_5ng <- mef_bens_plot_5ng %>% 
  ggplot(aes(x = input_tpm, y = percent)) +
  geom_point(size = 3, pch = 21) +
  geom_point(data = mef_bens_plot_5ng %>% filter(residuals > 30), color = "indianred4", size = 4, alpha = 0.4) +
  stat_smooth(col = "red") +
  labs(x = "Input mRNA amount\nlog2(TPM)", y = "Detected in x\ncoacervates [%]", title = "Input RNA amount: 5ng") +
  ylim(c(0,100))
plot(bens_plot_5ng)
```

#### Ben's plot 50pg

```{r}
input_50pg <- ool41 %>%
  filter(cell_id == "mef_50pg") %>% 
  filter(tpm != 0) %>% 
  group_by(target_id) %>% 
  summarise(input_tpm = log2_tpm)

  mef_bens_plot <- ool41_droplets %>% 
  filter(tpm != 0) %>% 
  group_by(target_id) %>% 
  summarise(ave_tpm = mean(log2_tpm), count = n()) %>% 
  inner_join(.,input_50pg, by="target_id") %>% distinct() %>% 
  arrange(desc(count)) %>% 
  mutate(percent = count*100/max(count)) 

# get residuals from model describing data in bens_plot
mef_bens_plot_model <- gam(percent ~ s(input_tpm, bs = "cs"), data = mef_bens_plot)
mef_bens_plot_50pg <- mef_bens_plot %>% mutate(residuals = mef_bens_plot_model$residuals)

bens_plot_50pg <- mef_bens_plot_50pg %>% 
  ggplot(aes(x = input_tpm, y = percent)) +
  geom_point(size = 3, pch = 21) +
  geom_point(data = mef_bens_plot_50pg %>% filter(residuals > 30), color = "indianred4", size = 4, alpha = 0.4) +
  stat_smooth(col = "red") +
  labs(x = "Input mRNA amount\nlog2(TPM)", y = "Detected in x\ncoacervates [%]", title = "Input RNA amount: 50pg") +
  ylim(c(0,100))
plot(bens_plot_50pg)
```


#### Compare residuals

```{r}
test <- full_join(mef_bens_plot_5ng, mef_bens_plot_50pg, by = "target_id", suffix = c(".5ng", ".50pg")) %>%
  drop_na() # to remove the genes which are only in one df -> will cause error when calc. pearson correl.

# calc pearson correlation for residuals (5ng vs. 50pg)
test_resid_rho <- paste("r = ", round(cor(test$residuals.5ng, test$residuals.50pg, method = "pearson"),2), sep = "")
# calc pearson correlation for input_tpm (5ng vs. 50pg)
test_input_rho <- paste("r = ", round(cor(test$input_tpm.50pg, test$input_tpm.5ng, method = "pearson"),2), sep = "")

resid_comp <- test %>% 
  ggplot(aes(x = residuals.5ng, residuals.50pg)) +
  geom_point(size = 3, alpha = .7, shape = 21) +
  geom_smooth(method = "lm") +
  annotate(geom = 'text', label = test_resid_rho, x = -50, y = 75, hjust = -.0, vjust = 0, size = 7) +
  labs(x = "Residuals\nInput RNA: 5ng", y = "Residuals\nInput RNA: 50pg", title = "Comparison of residuals")
plot(resid_comp)
```

#### Compare Input TPM values

```{r}
input_tpm_comp <- test %>% 
  ggplot(aes(x = input_tpm.5ng, y = input_tpm.50pg)) +
  geom_point(size = 3, alpha = .7, shape = 21) +
  geom_smooth(method = "lm") +
  annotate(geom = 'text', label = test_input_rho, x = 2, y = 15, hjust = -.0, vjust = 0, size = 7) +
  labs(x = "Input log2(TPM)\nRNA: 5ng", y = "Input log2(TPM)\nRNA: 50pg", title = "Comparison of Input RNA amount")
plot(input_tpm_comp)
```


#### Sample2Sample difference vs. Coacervate heterogeneity

Barbara's suggestion: Show that coacervate-to-coacervate differences are bigger than sample-to-sample differences. IÂ´m not 100% sure this is what the reviewer asks for, but while we're at it.... might as well

```{r}
sam2sam <- ool41 %>% 
  filter(cell_id == "mef_5ng" | cell_id == "mef_50pg") %>%
  filter(tpm != 0) %>% 
  group_by(target_id) %>% 
  summarise(CV = sd(tpm)/mean(tpm)) %>% 
  drop_na() %>% 
  mutate(comparison = "sam2sam")

coa2coa <- ool41 %>% 
  filter(grepl(pattern = "ool41_p1.*", x = .$cell_id)) %>% 
  filter(tpm != 0) %>% 
  group_by(target_id) %>% 
  summarise(CV = sd(tpm)/mean(tpm)) %>% 
  drop_na() %>% 
  mutate(comparison = "coa2coa")

all_comp <- bind_rows(sam2sam, coa2coa)

all_comp %>% 
  ggplot(aes(CV, fill = comparison)) +
  geom_histogram(color = "white") +
  geom_vline(data = all_comp %>% filter(comparison == "sam2sam"), aes(xintercept = median(CV)), linetype = 2) +
  geom_vline(data = all_comp %>% filter(comparison == "coa2coa"), aes(xintercept = median(CV)), linetype = 2) +
  facet_grid(comparison~.) +
  labs(x = "CV of TPM values", title = "Variation of transcript abundance")
```


#### Synthetic RNAs: ERCC spike-ins

```{r}
# Get length of ERCCs
ercc_length <- read.csv(file = "~/PD/Data/OoL/41_mef_rna_droplets/ercc_seqs.txt", sep = "\t") %>% 
  as.tbl() %>% 
  select(ERCC_ID, Sequence) %>% 
  rename(target_id = ERCC_ID) %>% 
  mutate(length = nchar(as.character(Sequence))) %>% 
  select(-Sequence)

# load ERCC concentrations
ercc <- read.csv(file = "~/PD/Data/OoL/41_mef_rna_droplets/ercc_spike_ins.txt", sep = "\t") %>% 
  as.tbl() %>% 
  rename(conc_mix1 = concentration.in.Mix.1..attomoles.ul., 
         conc_mix2 = concentration.in.Mix.2..attomoles.ul., 
         target_id = ERCC.ID) %>% 
  # add actual concentration in soup
  mutate(conc_fM = conc_mix1/80) %>% 
  # add length information
  left_join(., ercc_length, by = "target_id")



# correlate ERCC concentration with percent droplets the transcripts were found in
ercc_plot <- ool41_droplets %>% 
  filter(tpm != 0) %>% 
  filter(grepl(pattern = "ERCC.*", x = .$target_id)) %>% 
  group_by(target_id) %>% 
  summarise(ave_tpm = median(log2_tpm), deviation = sd(log2_tpm), count = n()) %>% 
  arrange(desc(count)) %>% 
  mutate(percent = count*100/130) %>% 
  right_join(., ercc %>% select(target_id, conc_fM, length), by = "target_id") %>%
  replace(is.na(.), 0) 

# calc pearson correlation between concentration and percent
ercc_rho <- paste("r = ", round(cor(ercc_plot$percent, ercc_plot$conc_fM, method = "pearson"),2), sep = "")

# plot
ercc_final_plot <- ercc_plot %>% 
  ggplot(aes(y = percent, x = conc_fM, size = length)) +
  geom_point(data = ercc_plot %>% filter(percent != 0), fill = "indianred1", alpha = .7, pch = 21) +
  geom_point(data = ercc_plot %>% filter(percent == 0), fill = "lightgrey", alpha = .7, pch = 21) +
  geom_smooth(show.legend = FALSE) +
  annotate(geom = 'text', label = ercc_rho, x = .01, y = 75, size = 7) +
  annotate(geom = 'text', label = "1 fM", x = .5, y = 40, size = 7, angle = 90, color = "red") +
  geom_vline(xintercept = 1, linetype = 2, color = "red") +
  scale_x_log10() +
  labs(title = "Synthetic RNA pool", x = "ERCC concentration [fM]", y = "Detected in x\ncoacervates [%]") 
plot(ercc_final_plot)
```

```{r, eval=F}
# save all plots
ggsave(bens_plot_5ng, file="~/PD/Data/OoL/43_Draft_5/_s_new1/bens_plot_5ng.png", width = 7, height = 7, device = "png")
ggsave(bens_plot_50pg, file="~/PD/Data/OoL/43_Draft_5/_s_new1/bens_plot_50pg.png", width = 7, height = 7, device = "png")
ggsave(input_tpm_comp, file="~/PD/Data/OoL/43_Draft_5/_s_new1/input_tpm_comp.png", width = 7, height = 7, device = "png")
ggsave(resid_comp, file="~/PD/Data/OoL/43_Draft_5/_s_new1/resid_comp.png", width = 7, height = 7, device = "png")
ggsave(ercc_final_plot, file="~/PD/Data/OoL/43_Draft_5/_s_new1/ercc_plot.png", width = 9, height = 5, device = "png")
```

